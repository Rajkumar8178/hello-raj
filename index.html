<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Raj! | Secure Messenger</title>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS FRAMEWORK (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        wa: {
                            bg: '#e3e5e8', panel: '#ffffff', header: '#44c732', 
                            chatbg: '#efeae2', sent: '#e7ffdb', received: '#ffffff',   
                            text: '#111b21', meta: '#667781', accent: '#44c732',     
                            hover: '#f0f2f5', red: '#ea0038', darkgreen: '#1a9e05'
                        }
                    },
                    boxShadow: {
                        'wa': '0 1px 0.5px rgba(11,20,26,.13)', 
                        'glow': '0 0 20px rgba(68, 199, 50, 0.4)',
                        'menu': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- EXTERNAL LIBS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* CSS STYLES */
        .chat-bg {
            background-color: #efeae2;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-repeat: repeat;
            background-size: 400px;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        .logo-gradient { background: linear-gradient(135deg, #7dfc5b 0%, #35cf28 100%); }
        
        .logo-bubble { 
            background: white; 
            border-radius: 50%; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .logo-bubble::after { 
            content: ''; 
            position: absolute; 
            bottom: 0px; 
            left: 20%; 
            width: 20px; 
            height: 20px; 
            background: white; 
            transform: rotate(45deg); 
            z-index: 0; 
            border-bottom-right-radius: 4px; 
        }
        .logo-text { 
            z-index: 10; 
            color: #1a9e05; 
            font-family: 'Poppins', sans-serif; 
            font-weight: 800; 
            line-height: 1; 
        }
        
        .msg-dropdown-trigger {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8) 20%, rgba(255,255,255,1));
            border-radius: 50%;
            width: 24px;
            height: 24px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            color: #667781;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .group:hover .msg-dropdown-trigger { display: flex; }
        .group:active .msg-dropdown-trigger { display: flex; }

        .mobile-hidden { display: none !important; }
        .mobile-flex { display: flex !important; }
    </style>
</head>
<body class="bg-wa-bg text-wa-text font-sans h-screen overflow-hidden selection:bg-wa-accent selection:text-white">

    <!-- TOAST NOTIFICATIONS -->
    <div id="toast-container" class="fixed top-20 right-4 z-[100] flex flex-col items-end pointer-events-none"></div>

    <!-- GLOBAL MESSAGE CONTEXT MENU -->
    <div id="msg-context-menu" class="hidden fixed bg-white rounded-lg shadow-menu z-[90] w-48 py-2 text-sm text-gray-700 animate-fade-in origin-top-right border border-gray-100">
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3" id="ctx-star-btn"><i class="far fa-star w-4"></i> Star Message</div>
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3" id="ctx-reply-btn"><i class="fas fa-reply w-4"></i> Reply</div>
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3" id="ctx-forward-btn"><i class="fas fa-share w-4"></i> Forward</div>
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center gap-3" id="ctx-copy-btn"><i class="far fa-copy w-4"></i> Copy</div>
        <div class="border-t border-gray-100 my-1"></div>
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-red-500 flex items-center gap-3" id="ctx-delete-btn"><i class="far fa-trash-alt w-4"></i> Delete Message</div>
    </div>

    <!-- MODALS -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full animate-shake">
            <h3 class="text-gray-800 font-semibold text-lg mb-2">Delete message?</h3>
            <p class="text-gray-500 text-sm mb-6">Are you sure you want to delete this message? This cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-5 py-2.5 rounded-xl text-gray-500 hover:bg-gray-100 transition-colors font-medium text-sm">Cancel</button>
                <button id="confirm-delete-btn" class="px-5 py-2.5 rounded-xl bg-red-500 text-white hover:bg-red-600 shadow-md transition-colors font-medium text-sm">Delete for everyone</button>
            </div>
        </div>
    </div>

    <div id="clear-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full animate-shake">
            <h3 class="text-gray-800 font-semibold text-lg mb-2">Clear chat?</h3>
            <p class="text-gray-500 text-sm mb-6">This will delete ALL messages in this view permanently.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-clear-btn" class="px-5 py-2.5 rounded-xl text-gray-500 hover:bg-gray-100 transition-colors font-medium text-sm">Cancel</button>
                <button id="confirm-clear-btn" class="px-5 py-2.5 rounded-xl bg-red-500 text-white hover:bg-red-600 shadow-md transition-colors font-medium text-sm">Clear Chat</button>
            </div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div id="forward-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full animate-fade-in">
            <h3 class="text-gray-800 font-semibold text-lg mb-4">Forward to...</h3>
            <div class="space-y-2">
                <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-gray-100" id="fwd-global-btn">
                    <div class="w-10 h-10 rounded-full bg-wa-header flex items-center justify-center text-white"><i class="fas fa-globe"></i></div>
                    <div><div class="font-medium text-gray-800">Hello Raj! Global</div><div class="text-xs text-gray-500">Public Channel</div></div>
                </div>
                <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-gray-100" id="fwd-saved-btn">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white"><i class="fas fa-bookmark"></i></div>
                    <div><div class="font-medium text-gray-800">Message Yourself</div><div class="text-xs text-gray-500">Saved Messages</div></div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="document.getElementById('forward-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full">
            <div class="text-center mb-6">
                <div class="w-24 h-24 logo-gradient rounded-3xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-green-200">
                    <div class="logo-bubble w-16 h-14"><div class="logo-text text-[10px] text-center">Hello<br>Raj!</div></div>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Hello Raj! Global</h2>
                <p class="text-wa-meta text-sm">Secure Group • 1.4K Members</p>
            </div>
            <div class="border-t border-gray-100 pt-4 space-y-2">
                <div class="flex items-center gap-4 text-wa-accent hover:bg-green-50 p-3 rounded-xl cursor-pointer"><i class="fas fa-phone"></i> Audio Call</div>
                <div class="flex items-center gap-4 text-wa-accent hover:bg-green-50 p-3 rounded-xl cursor-pointer"><i class="fas fa-video"></i> Video Call</div>
                <div class="flex items-center gap-4 text-red-500 hover:bg-red-50 p-3 rounded-xl cursor-pointer"><i class="fas fa-ban"></i> Block Group</div>
            </div>
            <button id="close-info-btn" class="mt-6 w-full py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-medium">Close</button>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-modal" class="fixed inset-0 z-[90] flex items-center justify-center p-4 overflow-hidden bg-white">
        <div class="absolute inset-0 bg-gradient-to-br from-green-50 via-white to-green-100 opacity-80"></div>
        <div class="absolute -top-20 -left-20 w-96 h-96 bg-green-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float"></div>
        <div class="absolute top-1/2 -right-20 w-72 h-72 bg-lime-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-float" style="animation-delay: 2s"></div>
        
        <div class="login-box bg-white/70 backdrop-blur-xl p-8 md:p-10 rounded-[2rem] w-full max-w-[420px] shadow-2xl shadow-green-100/50 z-10 relative border border-white/60">
            <div class="text-center mb-8">
                <div class="w-28 h-28 logo-gradient rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-glow transform hover:scale-105 transition-transform duration-500">
                    <div class="logo-bubble w-20 h-16 group-hover:rotate-3 transition-transform"><div class="logo-text text-sm text-center">Hello<br>Raj!</div></div>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome!</h1>
                <p class="text-gray-500 text-sm">Enter a name to join the chat</p>
            </div>
            <div class="space-y-5">
                <div class="group">
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 ml-1">Display Name</label>
                    <input type="text" id="username-in" class="w-full px-4 py-3.5 bg-gray-50/50 border border-gray-200 text-gray-800 rounded-xl focus:ring-2 focus:ring-wa-header/20 focus:border-wa-header outline-none transition-all placeholder-gray-300 font-medium" placeholder="Your Name (e.g. Raj)">
                </div>
                <div class="group hidden" id="password-group">
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 ml-1">Admin Password</label>
                    <div class="relative">
                        <input type="password" id="password-in" class="w-full px-4 py-3.5 bg-gray-50/50 border border-gray-200 text-gray-800 rounded-xl focus:ring-2 focus:ring-wa-header/20 focus:border-wa-header outline-none transition-all placeholder-gray-300 font-medium" placeholder="Enter password">
                        <i id="toggle-password" class="fas fa-eye absolute right-4 top-4 text-gray-400 cursor-pointer hover:text-wa-header"></i>
                    </div>
                </div>
                <div id="login-error" class="text-red-500 text-xs text-center opacity-0 h-4 font-medium transition-opacity"></div>
                <button id="login-btn" class="w-full logo-gradient hover:opacity-90 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 transition-all transform active:scale-[0.98] mt-2">Start Messaging</button>
            </div>
            <div class="mt-8 text-center text-[11px] text-gray-400"><i class="fas fa-shield-alt text-wa-header"></i> Secure End-to-End Encryption</div>
        </div>
    </div>

    <!-- MAIN APPLICATION UI -->
    <div id="app-container" class="hidden flex h-full mx-auto shadow-2xl overflow-hidden relative max-w-[1600px] bg-white xl:my-4 xl:h-[95vh] xl:rounded-2xl border border-gray-100">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="flex flex-col w-full md:w-[30%] max-w-[420px] bg-white border-r border-gray-100 h-full z-20">
            <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 h-[70px]">
                <div class="w-10 h-10 logo-gradient rounded-xl flex items-center justify-center shadow-sm">
                    <div class="logo-bubble w-6 h-5"><div class="logo-text text-[6px] leading-[6px]">HR!</div></div>
                </div>
                <div class="flex gap-6 text-gray-400 text-lg">
                    <i class="fas fa-users hover:text-wa-header transition-colors cursor-pointer"></i>
                    <i class="fas fa-comment-alt hover:text-wa-header transition-colors cursor-pointer"></i>
                    <i class="fas fa-ellipsis-v hover:text-wa-header transition-colors cursor-pointer"></i>
                </div>
            </div>
            <div class="p-3 border-b border-gray-50 bg-white">
                <div class="bg-gray-50 rounded-xl px-4 py-2.5 flex items-center gap-3 border border-gray-100">
                    <i class="fas fa-search text-gray-400 text-sm"></i>
                    <input type="text" id="contact-search" placeholder="Search chats..." class="bg-transparent text-sm w-full outline-none placeholder-gray-400 font-medium">
                </div>
            </div>
            <div id="contact-list" class="flex-1 overflow-y-auto bg-white p-2 space-y-1">
                <!-- Static Channels -->
                <div id="channel-global" class="contact-item px-4 py-3.5 flex items-center gap-4 cursor-pointer hover:bg-green-50 rounded-xl transition-all group">
                    <div class="w-12 h-12 rounded-full bg-wa-header flex items-center justify-center text-white text-xl shrink-0 shadow-sm"><i class="fas fa-globe"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h3 class="text-gray-800 font-semibold truncate text-base">Hello Raj! Global</h3>
                            <span class="text-xs text-gray-400 font-medium">12:30</span>
                        </div>
                        <p class="text-gray-500 text-sm truncate font-medium">Chat with everyone!</p>
                    </div>
                </div>
                <div id="channel-saved" class="contact-item px-4 py-3.5 flex items-center gap-4 cursor-pointer hover:bg-blue-50 rounded-xl transition-all group">
                    <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white text-xl shrink-0 shadow-sm"><i class="fas fa-bookmark"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h3 class="text-gray-800 font-semibold truncate text-base">Message Yourself (Saved)</h3>
                            <span class="text-xs text-gray-400 font-medium"></span>
                        </div>
                        <p class="text-gray-500 text-sm truncate font-medium">Keep your notes here</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CHAT AREA -->
        <main id="chat-area" class="hidden md:flex flex-1 flex-col relative w-full h-full bg-[#efeae2]">
            <div class="absolute inset-0 chat-bg z-0 pointer-events-none opacity-60"></div>
            
            <!-- HEADER -->
            <div class="bg-white/90 backdrop-blur-sm h-[70px] flex items-center px-6 justify-between border-b border-gray-100 z-20 shadow-sm">
                <div class="flex items-center gap-4 cursor-pointer" id="chat-header-info">
                    <div class="md:hidden text-gray-600 mr-1 p-2" id="back-btn"><i class="fas fa-arrow-left text-xl"></i></div>
                    <div class="w-10 h-10 rounded-full bg-wa-header flex items-center justify-center text-white text-lg shrink-0 shadow-sm"><i id="header-icon" class="fas fa-globe"></i></div>
                    <div class="flex flex-col">
                        <h1 id="header-title" class="font-bold text-gray-800 text-base truncate">Hello Raj! Global</h1>
                        <span id="header-status" class="text-xs text-wa-header font-medium truncate">tap here for group info</span>
                    </div>
                </div>
                <div class="flex items-center gap-5 text-gray-400 text-lg">
                    <i class="fas fa-search hover:text-wa-header cursor-pointer transition-colors" id="search-toggle"></i>
                    <i class="fas fa-paperclip hover:text-wa-header cursor-pointer transform -rotate-45 transition-colors" id="attach-btn-header"></i>
                    <div class="relative group">
                        <i class="fas fa-ellipsis-v hover:text-wa-header cursor-pointer py-2 px-3 transition-colors" id="menu-btn"></i>
                        <div id="menu-dropdown" class="hidden absolute right-0 top-10 w-52 bg-white rounded-xl shadow-xl py-2 z-50 text-sm text-gray-700 border border-gray-100 ring-1 ring-black/5">
                            <div class="px-4 py-2.5 hover:bg-green-50 cursor-pointer font-medium" id="menu-info">Group Info</div>
                            <div class="px-4 py-2.5 hover:bg-green-50 cursor-pointer font-medium" id="menu-msg-self">Message Yourself</div>
                            <div class="px-4 py-2.5 hover:bg-red-50 cursor-pointer text-red-500 font-medium" id="menu-clear">Clear Chat</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IN-CHAT SEARCH -->
            <div id="message-search-bar" class="hidden absolute top-[75px] right-6 bg-white shadow-lg p-3 rounded-xl z-30 flex items-center gap-3 border border-gray-100">
                <i class="fas fa-search text-gray-400 text-xs"></i>
                <input type="text" id="msg-search-input" placeholder="Search..." class="outline-none text-sm w-40 font-medium text-gray-700">
                <i class="fas fa-times text-gray-400 cursor-pointer hover:text-red-500 transition-colors" id="search-close"></i>
            </div>

            <!-- MESSAGES LIST -->
            <div id="message-list" class="flex-1 overflow-y-auto px-4 md:px-16 py-6 space-y-2 z-10 scroll-smooth"></div>

            <!-- INPUT AREA -->
            <!-- Reply Preview Banner -->
            <div id="reply-preview" class="hidden bg-white/95 px-4 py-2 border-t border-gray-200 flex justify-between items-center z-20">
                 <div class="flex-1 border-l-4 border-wa-header pl-2 bg-gray-50 rounded p-1">
                     <div class="text-xs text-wa-header font-bold mb-1" id="reply-to-name">User</div>
                     <div class="text-xs text-gray-500 truncate" id="reply-content">...</div>
                 </div>
                 <i class="fas fa-times text-gray-500 p-2 cursor-pointer hover:bg-gray-100 rounded-full" id="close-reply-btn"></i>
            </div>

            <div class="bg-[#f0f2f5] p-3 md:px-6 md:py-3 z-20 flex items-end gap-3 relative border-t border-gray-200/50">
                <div id="file-preview" class="hidden absolute bottom-20 left-6 bg-white p-3 rounded-xl shadow-lg border border-gray-200 flex flex-wrap gap-2 z-30 animate-float"></div>
                
                <div class="flex pb-2.5 gap-3 text-gray-500 text-2xl px-1">
                    <button id="emoji-btn" class="hover:text-wa-header transition-colors hover:scale-110 transform duration-200"><i class="far fa-smile"></i></button>
                    <button id="file-btn" class="hover:text-wa-header transition-colors hover:scale-110 transform duration-200"><i class="fas fa-plus"></i></button>
                    <input type="file" id="file-input" class="hidden">
                </div>

                <div class="flex-1 bg-white rounded-2xl flex items-center min-h-[48px] relative shadow-sm border border-gray-200 focus-within:border-wa-header focus-within:ring-2 focus-within:ring-wa-header/10 transition-all mb-1">
                     <textarea id="message-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 text-gray-800 placeholder-gray-400 resize-none py-3 px-4 max-h-32 text-[15px] leading-relaxed font-medium" placeholder="Type a message..."></textarea>
                </div>

                <button id="send-btn" class="mb-1 w-12 h-12 flex items-center justify-center text-white bg-wa-header hover:bg-[#32ad32] rounded-full shadow-md hover:shadow-lg transition-all transform hover:scale-105 active:scale-95">
                    <i class="fas fa-paper-plane text-lg ml-[-2px] mt-[2px]"></i>
                </button>

                <div id="emoji-picker" class="hidden absolute bottom-20 left-4 bg-white border border-gray-200 rounded-2xl p-3 grid grid-cols-8 gap-1 w-[90%] md:w-80 shadow-2xl h-72 overflow-y-auto z-40"></div>
            </div>
        </main>
    </div>

    <!-- JAVASCRIPT LOGIC (VANILLA JS MODULE) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SYSTEM_CONFIG = {
            ADMIN_USER: 'Admin247',
            ADMIN_PASS: 'Admin@7840015',
            ENCRYPTION_KEY: 'SECRET_KEY_784',
            GLOBAL_CHANNEL: 'global_chat',
            SAVED_CHANNEL: 'saved_messages',
            MAX_FILE_SIZE: 950 * 1024,
            UI_UPLOAD_LIMIT: 50 * 1024 * 1024
        };

        class AuthService {
            constructor(firebaseAuth) {
                this.auth = firebaseAuth;
                this.currentUser = null;
                this.username = "Guest";
            }

            async login(username, password) {
                if (username === SYSTEM_CONFIG.ADMIN_USER) {
                     if(password !== SYSTEM_CONFIG.ADMIN_PASS) {
                         throw new Error("Invalid Admin Password");
                     }
                }
                
                try {
                    if (this.auth) {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(this.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(this.auth);
                        }
                        this.currentUser = this.auth.currentUser;
                        this.username = username;
                    } else {
                        this.currentUser = { uid: 'demo-user-' + Date.now() };
                        this.username = username;
                    }
                    return true;
                } catch(e) {
                    console.error("Auth Error:", e);
                    if (typeof __firebase_config === 'undefined') {
                        throw new Error("System Config Missing. Check environment.");
                    }
                    throw new Error("Connection Error: " + e.message);
                }
            }

            getCurrentUser() {
                return { ...this.currentUser, displayName: this.username };
            }
        }

        class ChatService {
            constructor(db, appId) {
                this.db = db;
                this.appId = appId;
                this.globalMessages = [];
                this.privateMessages = [];
                this.localPendingMessages = [];
                this.pendingUpdateCallback = null;
            }

            subscribeToMessages(userId, onUpdateCallback) {
                this.pendingUpdateCallback = onUpdateCallback;
                if (!this.db) return; 

                const qGlobal = query(collection(this.db, 'artifacts', this.appId, 'public', 'data', SYSTEM_CONFIG.GLOBAL_CHANNEL));
                onSnapshot(qGlobal, { includeMetadataChanges: true }, (snapshot) => {
                    this.globalMessages = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        this.globalMessages.push({ 
                            id: doc.id, 
                            ...data, 
                            source: 'global',
                            isPending: doc.metadata.hasPendingWrites 
                        });
                    });
                    this.triggerUpdate();
                });

                const qPrivate = query(collection(this.db, 'artifacts', this.appId, 'users', userId, SYSTEM_CONFIG.SAVED_CHANNEL));
                onSnapshot(qPrivate, { includeMetadataChanges: true }, (snapshot) => {
                    this.privateMessages = [];
                    snapshot.forEach(doc => {
                         this.privateMessages.push({ 
                            id: doc.id, 
                            ...doc.data(), 
                            source: 'private',
                            isPending: doc.metadata.hasPendingWrites
                        });
                    });
                    this.triggerUpdate();
                });
            }

            triggerUpdate() {
                if (this.pendingUpdateCallback) this.pendingUpdateCallback();
            }

            async retryPendingMessages() {
                if (!navigator.onLine) return;
                const pending = [...this.localPendingMessages];
                for (const msg of pending) {
                    if (msg.retryData) {
                        try {
                            const { collectionPath, payload } = msg.retryData;
                            await addDoc(collection(this.db, 'artifacts', this.appId, ...collectionPath), payload);
                            this.localPendingMessages = this.localPendingMessages.filter(m => m.id !== msg.id);
                            this.triggerUpdate();
                        } catch (e) { console.warn("Retry failed", e); }
                    }
                }
            }

            async sendMessage(text, fileData, fileType, fileName, isSavedView, userId, senderName, replyContext) {
                const encrypted = CryptoJS.AES.encrypt(text, SYSTEM_CONFIG.ENCRYPTION_KEY).toString();
                const tempId = 'temp-' + Date.now();
                const collectionPath = isSavedView 
                    ? ['users', userId, SYSTEM_CONFIG.SAVED_CHANNEL] 
                    : ['public', 'data', SYSTEM_CONFIG.GLOBAL_CHANNEL];
                    
                const payload = {
                    sender: senderName,
                    encryptedContent: encrypted,
                    attachment: fileData || null,
                    attachmentType: fileType || null,
                    attachmentName: fileName || null,
                    timestamp: serverTimestamp(),
                    replyTo: replyContext || null 
                };

                const tempMsg = {
                    id: tempId,
                    sender: senderName,
                    encryptedContent: encrypted,
                    attachment: fileData,
                    attachmentType: fileType,
                    attachmentName: fileName,
                    timestamp: { toMillis: () => Date.now() },
                    isPending: true,
                    source: isSavedView ? 'private' : 'global',
                    retryData: { payload, collectionPath },
                    replyTo: replyContext || null
                };

                this.localPendingMessages.push(tempMsg);
                this.triggerUpdate();

                if (!this.db || !navigator.onLine) return;

                try {
                    await addDoc(collection(this.db, 'artifacts', this.appId, ...collectionPath), payload);
                    this.localPendingMessages = this.localPendingMessages.filter(m => m.id !== tempId);
                    this.triggerUpdate();
                } catch (e) { console.warn("Send failed", e); }
            }
            
            getMessagesForView(view, savedIds) {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                
                let serverMsgs = [];
                if (view === 'global') {
                    serverMsgs = this.globalMessages.filter(msg => {
                        if (!msg.timestamp) return true;
                        const isOld = (now - msg.timestamp.toMillis() > oneDay);
                        const isSaved = savedIds.has(msg.id);
                        return (isSaved || !isOld); 
                    });
                } else {
                     const savedGlobal = this.globalMessages.filter(m => savedIds.has(m.id));
                     serverMsgs = [...savedGlobal, ...this.privateMessages];
                }

                const relevantPending = this.localPendingMessages.filter(m => m.source === view);
                
                // Deduplicate: If a message is in serverMsgs AND relevantPending (race condition), keep server one
                const serverIds = new Set(serverMsgs.map(m => m.id));
                const uniquePending = relevantPending.filter(m => !serverIds.has(m.id));

                return [...serverMsgs, ...uniquePending].sort((a,b) => {
                    const tA = a.timestamp ? a.timestamp.toMillis() : Date.now();
                    const tB = b.timestamp ? b.timestamp.toMillis() : Date.now();
                    return tA - tB;
                });
            }

            async deleteMessage(messageId, source, userId) {
                this.localPendingMessages = this.localPendingMessages.filter(m => m.id !== messageId);
                this.triggerUpdate();
                if (!this.db) return;
                const collectionPath = source === 'private' 
                    ? ['users', userId, SYSTEM_CONFIG.SAVED_CHANNEL]
                    : ['public', 'data', SYSTEM_CONFIG.GLOBAL_CHANNEL];
                await deleteDoc(doc(this.db, 'artifacts', this.appId, ...collectionPath, messageId));
            }

            async clearChat(isSavedView, userId, messages) {
                this.localPendingMessages = this.localPendingMessages.filter(m => m.source !== (isSavedView ? 'private' : 'global'));
                this.triggerUpdate();
                if (!this.db) return;
                const promises = messages.map(msg => {
                     if (msg.id.startsWith('temp-')) return Promise.resolve();
                     return this.deleteMessage(msg.id, isSavedView ? 'private' : 'global', userId);
                });
                await Promise.all(promises);
            }
        }

        class LoginController {
            constructor(authService, onSuccess) {
                this.authService = authService;
                this.onSuccess = onSuccess;
                this.initListeners();
            }

            initListeners() {
                const btn = document.getElementById('login-btn');
                const userIn = document.getElementById('username-in');
                const passGroup = document.getElementById('password-group');
                
                userIn.addEventListener('input', (e) => {
                    if(e.target.value === SYSTEM_CONFIG.ADMIN_USER) { passGroup.classList.remove('hidden'); } 
                    else { passGroup.classList.add('hidden'); }
                });

                if (btn) btn.addEventListener('click', () => this.attemptLogin());
                
                const toggle = document.getElementById('toggle-password');
                const passInput = document.getElementById('password-in');
                if (toggle && passInput) {
                    toggle.addEventListener('click', () => {
                        const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passInput.setAttribute('type', type);
                        toggle.classList.toggle('fa-eye'); toggle.classList.toggle('fa-eye-slash');
                    });
                }
                
                userIn.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.attemptLogin(); });
                if(passInput) passInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.attemptLogin(); });
            }

            async attemptLogin() {
                const u = document.getElementById('username-in').value.trim();
                const p = document.getElementById('password-in').value.trim();
                if(!u) { this.showError("Please enter a name"); return; }
                const loginModal = document.getElementById('login-modal');
                const appContainer = document.getElementById('app-container');
                const btn = document.getElementById('login-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Processing...`;
                btn.disabled = true;

                try {
                    const success = await this.authService.login(u, p);
                    if (success) {
                        setTimeout(() => {
                            loginModal.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            this.onSuccess(this.authService.getCurrentUser());
                        }, 500); 
                    }
                } catch(error) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    this.showError(error.message);
                    document.querySelector('.login-box').classList.add('animate-shake');
                    setTimeout(() => document.querySelector('.login-box').classList.remove('animate-shake'), 500);
                }
            }

            showError(msg) {
                const el = document.getElementById('login-error');
                el.innerText = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000);
            }
        }

        class UIManager {
            constructor(chatService) {
                this.chatService = chatService;
                this.currentView = 'global';
                this.savedMessageIds = new Set(JSON.parse(localStorage.getItem('justchart_saved') || '[]'));
                this.tempMessageData = null; // For context menu actions
                this.replyingTo = null; // State for reply
                this.currentUser = null;
                this.searchTerm = '';
                this.initEventListeners();
                this.monitorConnection();
            }

            init(user) {
                this.currentUser = user;
                this.chatService.subscribeToMessages(user.uid, () => this.renderChat());
                document.getElementById('header-status').innerText = "tap here for group info";
                this.showToast(`Welcome, ${user.displayName}!`, "success");
            }
            
            monitorConnection() {
                const updateStatus = () => {
                    const statusEl = document.getElementById('header-status');
                    if (navigator.onLine) {
                        statusEl.innerHTML = `<span class="text-green-600 font-bold">● Online</span>`;
                        this.chatService.retryPendingMessages();
                    } else {
                        statusEl.innerHTML = `<span class="text-red-500 font-bold">● Waiting for network...</span>`;
                    }
                };
                window.addEventListener('online', updateStatus);
                window.addEventListener('offline', updateStatus);
                updateStatus();
            }

            initEventListeners() {
                document.getElementById('channel-global').addEventListener('click', () => this.switchChannel('global'));
                document.getElementById('channel-saved').addEventListener('click', () => this.switchChannel('saved'));
                document.getElementById('back-btn').addEventListener('click', () => this.toggleMobileView(false));
                document.getElementById('send-btn').addEventListener('click', () => this.handleSendMessage());
                document.getElementById('message-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.handleSendMessage(); }
                });
                document.getElementById('file-btn').addEventListener('click', () => document.getElementById('file-input').click());
                document.getElementById('attach-btn-header').addEventListener('click', () => document.getElementById('file-input').click());
                document.getElementById('file-input').addEventListener('change', (e) => this.handleFileSelect(e));
                
                document.getElementById('chat-header-info').addEventListener('click', () => this.toggleModal('info-modal', true));
                document.getElementById('menu-info').addEventListener('click', () => this.toggleModal('info-modal', true));
                document.getElementById('close-info-btn').addEventListener('click', () => this.toggleModal('info-modal', false));
                document.getElementById('menu-btn').addEventListener('click', () => document.getElementById('menu-dropdown').classList.toggle('hidden'));
                
                // Add Message Yourself to main menu
                document.getElementById('menu-msg-self').addEventListener('click', () => {
                    document.getElementById('menu-dropdown').classList.add('hidden');
                    this.switchChannel('saved');
                });

                document.getElementById('menu-clear').addEventListener('click', () => {
                    document.getElementById('menu-dropdown').classList.add('hidden');
                    this.toggleModal('clear-modal', true);
                });
                document.getElementById('cancel-clear-btn').addEventListener('click', () => this.toggleModal('clear-modal', false));
                document.getElementById('confirm-clear-btn').addEventListener('click', () => this.handleClearChat());
                document.getElementById('cancel-delete-btn').addEventListener('click', () => this.toggleModal('delete-modal', false));
                document.getElementById('confirm-delete-btn').addEventListener('click', () => this.handleConfirmDelete());
                
                document.getElementById('search-toggle').addEventListener('click', () => {
                    const bar = document.getElementById('message-search-bar');
                    bar.classList.toggle('hidden');
                    if(!bar.classList.contains('hidden')) document.getElementById('msg-search-input').focus();
                });
                document.getElementById('search-close').addEventListener('click', () => {
                     document.getElementById('message-search-bar').classList.add('hidden');
                     this.searchTerm = '';
                     this.renderChat();
                });
                document.getElementById('msg-search-input').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.renderChat();
                });

                document.getElementById('close-reply-btn').addEventListener('click', () => this.cancelReply());
                
                document.getElementById('ctx-delete-btn').addEventListener('click', () => {
                    this.toggleModal('delete-modal', true);
                    this.hideContextMenu();
                });
                document.getElementById('ctx-reply-btn').addEventListener('click', () => { 
                    this.startReply(this.tempMessageData);
                    this.hideContextMenu(); 
                });
                document.getElementById('ctx-forward-btn').addEventListener('click', () => { 
                    this.toggleModal('forward-modal', true);
                    this.hideContextMenu(); 
                });
                document.getElementById('ctx-copy-btn').addEventListener('click', () => { 
                    this.copyMessageText(this.tempMessageData.content);
                    this.hideContextMenu(); 
                });
                document.getElementById('ctx-star-btn').addEventListener('click', () => {
                    if (this.tempMessageData) this.toggleStar(this.tempMessageData.id);
                    this.hideContextMenu();
                });

                document.getElementById('fwd-global-btn').addEventListener('click', () => this.handleForward('global'));
                document.getElementById('fwd-saved-btn').addEventListener('click', () => this.handleForward('saved'));

                document.addEventListener('click', (e) => this.handleGlobalClicks(e));
                this.renderEmojiPicker();
            }

            switchChannel(view) {
                this.currentView = view;
                this.toggleMobileView(true);
                this.updateHeaderUI();
                this.renderChat();
            }

            updateHeaderUI() {
                const isGlobal = this.currentView === 'global';
                const gTab = document.getElementById('channel-global');
                const sTab = document.getElementById('channel-saved');
                if (isGlobal) {
                    gTab.classList.add('bg-green-50'); sTab.classList.remove('bg-blue-50');
                    document.getElementById('header-title').innerText = "Hello Raj! Global";
                    document.getElementById('header-icon').className = "fas fa-globe";
                } else {
                    sTab.classList.add('bg-blue-50'); gTab.classList.remove('bg-green-50');
                    document.getElementById('header-title').innerText = "Saved Messages";
                    document.getElementById('header-icon').className = "fas fa-bookmark";
                }
            }

            toggleMobileView(showChat) {
                const sidebar = document.getElementById('sidebar');
                const chat = document.getElementById('chat-area');
                if (window.innerWidth < 768) {
                    if (showChat) { sidebar.classList.add('hidden'); chat.classList.remove('hidden'); chat.classList.add('flex'); } 
                    else { chat.classList.add('hidden'); sidebar.classList.remove('hidden'); }
                }
            }

            renderChat() {
                const list = document.getElementById('message-list');
                const statics = Array.from(list.children).filter(c => c.innerHTML.includes('Messages are end-to-end'));
                list.innerHTML = ''; statics.forEach(e => list.appendChild(e));

                let messages = this.chatService.getMessagesForView(this.currentView, this.savedMessageIds);

                if (this.searchTerm) {
                    messages = messages.filter(msg => {
                        const content = this.decryptMessage(msg.encryptedContent).toLowerCase();
                        return content.includes(this.searchTerm);
                    });
                }

                messages.forEach(msg => {
                    const isMe = msg.sender === this.currentUser.displayName;
                    const isSaved = this.savedMessageIds.has(msg.id) || msg.source === 'private';
                    let content = this.decryptMessage(msg.encryptedContent);
                    
                    const div = document.createElement('div');
                    div.className = `flex w-full mb-2 ${isMe ? 'justify-end' : 'justify-start'}`;
                    const bubbleClass = isMe ? 'bg-[#e7ffdb] rounded-tr-none' : 'bg-white rounded-tl-none';

                    let replyBlock = '';
                    if (msg.replyTo) {
                        replyBlock = `
                            <div class="bg-black/5 border-l-4 border-wa-header rounded p-1 mb-1 text-xs cursor-pointer opacity-80">
                                <div class="font-bold text-wa-header">${msg.replyTo.sender}</div>
                                <div class="truncate text-gray-500">${msg.replyTo.text || 'File Attachment'}</div>
                            </div>
                        `;
                    }

                    let fileHTML = '';
                    if(msg.attachment) {
                        const name = msg.attachmentName || 'file';
                        if(msg.attachmentType?.startsWith('image')) {
                            fileHTML = `<div class="mb-1 rounded-lg overflow-hidden relative group border border-gray-100"><img src="${msg.attachment}" class="max-w-[280px] max-h-[300px] object-cover"><a href="${msg.attachment}" download="${name}" class="absolute bottom-2 right-2 bg-black/50 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition backdrop-blur-sm"><i class="fas fa-download"></i></a></div>`;
                        } else {
                            fileHTML = `<div class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg mb-1 cursor-pointer border border-gray-100 hover:bg-gray-100 transition-colors" onclick="window.open('${msg.attachment}')"><div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center text-wa-header"><i class="fas fa-file-alt text-xl"></i></div><div class="overflow-hidden"><div class="text-sm font-semibold text-gray-800 truncate w-32">${name}</div><div class="text-[10px] text-gray-500 font-medium">FILE</div></div><a href="${msg.attachment}" download="${name}" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-wa-header hover:bg-wa-header hover:text-white transition-all ml-2" title="Download"><i class="fas fa-download text-sm"></i></a></div>`;
                        }
                    }

                    const colors = ['text-orange-500', 'text-purple-500', 'text-blue-500', 'text-pink-500', 'text-teal-500'];
                    const nameColor = colors[msg.sender.length % colors.length];

                    let statusIcon = `<i class="fas fa-check-double text-[#53bdeb] text-[10px]" title="Delivered"></i>`;

                    const menuTrigger = `
                        <div class="msg-dropdown-trigger absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-gradient-to-l from-white/90 to-transparent rounded-bl-lg pl-2 pt-1 cursor-pointer z-10" onclick="window.showMsgMenu(event, '${msg.id}', '${msg.source}', ${isSaved})">
                            <i class="fas fa-chevron-down text-gray-500 hover:text-gray-700"></i>
                        </div>
                    `;

                    // Only render if valid content
                    if (content || fileHTML) {
                        div.innerHTML = `
                            <div class="max-w-[85%] md:max-w-[65%] group relative flex items-end animate-fade-in-up">
                                <div class="px-3 py-2 rounded-2xl shadow-sm ${bubbleClass} relative min-w-[100px] border border-gray-200/50 group">
                                    ${menuTrigger}
                                    ${!isMe && msg.source === 'global' ? `<div class="text-xs font-bold ${nameColor} mb-1">${msg.sender}</div>` : ''}
                                    ${replyBlock}
                                    ${fileHTML}
                                    ${content ? `<div class="text-[15px] text-gray-800 pb-4 leading-relaxed whitespace-pre-wrap font-normal" id="msg-txt-${msg.id}">${content}</div>` : ''}
                                    <span class="absolute bottom-1.5 right-2 text-[10px] text-gray-400 flex items-center gap-1 select-none font-medium">
                                        ${msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}
                                        ${isMe ? statusIcon : ''}
                                        ${isSaved && msg.source === 'global' ? '<i class="fas fa-star text-yellow-400 ml-1 text-[10px]"></i>' : ''}
                                    </span>
                                </div>
                            </div>`;
                        list.appendChild(div);
                    }
                });
                list.scrollTop = list.scrollHeight;
            }

            decryptMessage(cipher) {
                try { 
                    const bytes = CryptoJS.AES.decrypt(cipher, SYSTEM_CONFIG.ENCRYPTION_KEY);
                    const originalText = bytes.toString(CryptoJS.enc.Utf8);
                    return originalText || ""; 
                } catch(e) { return ""; }
            }

            startReply(msgData) {
                this.replyingTo = { 
                    id: msgData.id, 
                    sender: msgData.sender || "User", 
                    text: msgData.content ? msgData.content.substring(0, 50) + (msgData.content.length>50?"...":"") : "File Attachment" 
                };
                document.getElementById('reply-preview').classList.remove('hidden');
                document.getElementById('reply-to-name').innerText = this.replyingTo.sender;
                document.getElementById('reply-content').innerText = this.replyingTo.text;
                document.getElementById('message-input').focus();
            }

            cancelReply() {
                this.replyingTo = null;
                document.getElementById('reply-preview').classList.add('hidden');
            }

            async handleForward(targetView) {
                this.toggleModal('forward-modal', false);
                if (!this.tempMessageData) return;
                
                const content = this.tempMessageData.content; 
                const allMsgs = this.tempMessageData.source === 'global' ? this.chatService.globalMessages : this.chatService.privateMessages;
                const originalMsg = allMsgs.find(m => m.id === this.tempMessageData.id);
                
                if (originalMsg) {
                    await this.chatService.sendMessage(content || "", originalMsg.attachment, originalMsg.attachmentType, originalMsg.attachmentName, targetView === 'saved', this.currentUser.uid, this.currentUser.displayName);
                    this.showToast("Message Forwarded", "success");
                    if (targetView !== this.currentView) this.switchChannel(targetView);
                } else {
                    this.showToast("Cannot forward (Message expired)", "error");
                }
            }

            copyMessageText(text) {
                if (!text) {
                     this.showToast("Nothing to copy", "info");
                     return;
                }
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast("Text copied", "success");
                }).catch(() => this.showToast("Failed to copy", "error"));
            }

            async handleSendMessage() {
                const input = document.getElementById('message-input');
                const fileInput = document.getElementById('file-input');
                const text = input.value.trim();
                const file = fileInput.files[0];
                if (!text && !file) return;

                const currentText = text;
                const currentReply = this.replyingTo; 
                
                input.value = ''; 
                fileInput.value = ''; 
                document.getElementById('file-preview').classList.add('hidden');
                this.cancelReply(); 

                let fileData = null;
                if (file) {
                    if (file.size > SYSTEM_CONFIG.UI_UPLOAD_LIMIT) { this.showToast("File > 50MB", "error"); return; }
                    try {
                        fileData = file.type.startsWith('image') ? await this.compressImage(file) : await this.toBase64(file);
                    } catch(e) { this.showToast(e.message, "error"); return; }
                }

                try {
                    await this.chatService.sendMessage(currentText, fileData, file?.type, file?.name, this.currentView === 'saved', this.currentUser.uid, this.currentUser.displayName, currentReply);
                } catch (e) { this.showToast("Error processing", "error"); }
            }
            
            async handleClearChat() {
                this.toggleModal('clear-modal', false);
                const msgs = this.chatService.getMessagesForView(this.currentView, this.savedMessageIds);
                if (msgs.length === 0) return this.showToast("Chat empty", "info");
                this.showToast("Clearing...", "info");
                await this.chatService.clearChat(this.currentView === 'saved', this.currentUser.uid, msgs);
                this.showToast("Cleared", "success");
            }

            async handleConfirmDelete() {
                if(this.tempMessageToDelete) {
                    await this.chatService.deleteMessage(this.tempMessageToDelete.id, this.tempMessageToDelete.source, this.currentUser.uid);
                    this.showToast("Deleted", "success");
                    this.toggleModal('delete-modal', false);
                    this.tempMessageToDelete = null;
                }
            }

            toggleStar(id) {
                if (this.savedMessageIds.has(id)) this.savedMessageIds.delete(id); else this.savedMessageIds.add(id);
                localStorage.setItem('justchart_saved', JSON.stringify([...this.savedMessageIds]));
                this.renderChat();
            }

            prepareMessageData(id, source) {
                const allMsgs = source === 'global' ? this.chatService.globalMessages : this.chatService.privateMessages;
                const msgObj = allMsgs.find(m => m.id === id);
                if (msgObj) {
                    const decrypted = this.decryptMessage(msgObj.encryptedContent);
                    this.tempMessageData = { id, source, content: decrypted, sender: msgObj.sender };
                    this.tempMessageToDelete = { id, source }; 
                    return true;
                }
                return false;
            }

            showContextMenu(event, id, source, isStarred) {
                event.stopPropagation();
                if (!this.prepareMessageData(id, source)) return;
                
                const menu = document.getElementById('msg-context-menu');
                const starBtn = document.getElementById('ctx-star-btn');
                starBtn.innerHTML = isStarred ? '<i class="fas fa-star w-4 text-yellow-400"></i> Unstar' : '<i class="far fa-star w-4"></i> Star';
                
                const clickX = event.clientX;
                const clickY = event.clientY;
                menu.style.top = `${clickY + 10}px`;
                if (window.innerWidth - clickX < 200) { menu.style.left = 'auto'; menu.style.right = `${window.innerWidth - clickX}px`; } 
                else { menu.style.left = `${clickX}px`; menu.style.right = 'auto'; }
                menu.classList.remove('hidden');
            }

            showForwardMenu(event, id, source) {
                event.stopPropagation();
                if (this.prepareMessageData(id, source)) {
                    this.toggleModal('forward-modal', true);
                }
            }

            hideContextMenu() { document.getElementById('msg-context-menu').classList.add('hidden'); }
            toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }
            
            showToast(msg, type) {
                const t = document.createElement('div');
                t.className = `${type==='error'?'bg-red-500':'bg-wa-header'} text-white px-5 py-2.5 rounded-xl shadow-lg mb-3 text-sm animate-shake font-medium flex items-center gap-2`;
                t.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle':'fa-check-circle'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(()=>t.remove(), 3000);
            }

            handleFileSelect(e) {
                if (e.target.files[0]) {
                    const prev = document.getElementById('file-preview');
                    prev.classList.remove('hidden');
                    prev.innerHTML = `<div class="bg-gray-100 rounded-lg p-2 text-xs flex items-center gap-2 font-medium"><i class="fas fa-file text-wa-header"></i> ${e.target.files[0].name.substring(0,12)}...</div>`;
                }
            }

            handleGlobalClicks(e) {
                const btn = document.getElementById('emoji-btn');
                const picker = document.getElementById('emoji-picker');
                if (btn && !btn.contains(e.target) && !picker.contains(e.target)) picker.classList.add('hidden');
                
                const ctxMenu = document.getElementById('msg-context-menu');
                if (!ctxMenu.contains(e.target)) this.hideContextMenu();
            }

            toBase64(f) { return new Promise((r,j)=>{const d=new FileReader(); d.readAsDataURL(f); d.onload=()=>r(d.result); d.onerror=j;}); }
            compressImage(f) { return new Promise((r)=>{const d=new FileReader(); d.readAsDataURL(f); d.onload=(e)=>{const i=new Image(); i.src=e.target.result; i.onload=()=>{const c=document.createElement('canvas'), x=c.getContext('2d'), M=1000; let w=i.width, h=i.height; if(w>h){if(w>M){h*=M/w;w=M}}else{if(h>M){w*=M/h;h=M}} c.width=w; c.height=h; x.drawImage(i,0,0,w,h); r(c.toDataURL(f.type,0.7));}}}); }

            renderEmojiPicker() {
                const emojis = ['😀','😃','😄','😁','😆','😅','😂','🤣','🥲','🥹','😊','😇','🙂','🙃','😉','😌','😍','🥰','😘','😗','😙','😚','😋','😛','😝','😜','🤪','🤨','🧐','🤓','😎','🥸','🤩','🥳','😏','😒','😞','😔','😟','😕','🙁','☹️','😣','😖','😫','😩','🥺','😢','😭','😤','😠','😡','🤬','🤯','😳','🥵','🥶','😱','😨','😰','😥','😓','🤗','🤔','🫣','🤭','🫡','🤫','🫠','🤥','😶','🫥','😐','😑','😬','🙄','😯','😦','😧','😮','😲','🥱','😴','🤤','😪','😵','😵‍💫','🤐','🥴','🤢','🤮','🤧','😷','🤒','🤕','🤑','🤠','😈','👿','👹','👺','🤡','💩','👻','💀','☠️','👽','👾','🤖','🎃','😺','😸','😹','😻','😼','😽','🙀','😿','😾','🫶','👋','🤚','🖐️','✋','🖖','👌','🤌','🤏','✌️','🤞','🫰','🤟','🤘','🤙','👈','👉','👆','👇','👍','👎','✊','👊','🤛','🤜','👏','🙌','👐','🤲','🤝','🙏','✍️','💅','🤳','💪','🦵','🦶','👂','🦻','👃','🧠','🫀','🫁','🦷','🦴','👀','👁️','👅','👄','💋','🩸'];
                const picker = document.getElementById('emoji-picker');
                emojis.forEach(e => {
                    const s = document.createElement('span'); s.innerText = e;
                    s.className = "cursor-pointer text-2xl hover:bg-gray-100 p-2 rounded-lg text-center transition-colors select-none";
                    s.onclick = () => { document.getElementById('message-input').value += e; picker.classList.add('hidden'); document.getElementById('message-input').focus(); }
                    picker.appendChild(s);
                });
                document.getElementById('emoji-btn').onclick = () => picker.classList.toggle('hidden');
            }
        }

        class HelloRajApp {
            static main() {
                document.addEventListener('DOMContentLoaded', () => {
                    let app, auth, db, appId = 'default-app-id';
                    try {
                        if (typeof __firebase_config !== 'undefined') {
                            const firebaseConfig = JSON.parse(__firebase_config);
                            app = initializeApp(firebaseConfig);
                            auth = getAuth(app);
                            db = getFirestore(app);
                            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                            try { enableIndexedDbPersistence(db).catch(err => console.log("Persistence suppressed")); } catch(e) {}
                        }
                    } catch (error) { console.error("Initialization Warning:", error); }

                    const authService = new AuthService(auth);
                    const chatService = new ChatService(db, appId);
                    const uiManager = new UIManager(chatService);
                    window.showMsgMenu = (e, id, src, isStarred) => uiManager.showContextMenu(e, id, src, isStarred);
                    window.showForwardMenu = (e, id, src) => uiManager.showForwardMenu(e, id, src);
                    new LoginController(authService, (user) => uiManager.init(user));
                });
            }
        }
        HelloRajApp.main();
    </script>
</body>
</html>
